<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MANDUU.ViewModels"
             xmlns:icons="clr-namespace:MANDUU.Helpers"
             xmlns:models="clr-namespace:MANDUU.Models"
             x:Class="MANDUU.Views.MainPages.SubPages.CategoryPage"
             x:Name="CategoryPageRoot"
             Title="{Binding SelectedMainCategory.Name}">

    <Grid RowDefinitions="Auto,*">
        <!-- Banner -->
        <Border Grid.Row="0" Margin="5,0,5,10" StrokeShape="RoundRectangle 5" HeightRequest="70">
            <Grid>
                <Image Source="{Binding SelectedMainCategory.BannerImage}" Aspect="AspectFill"/>
            </Grid>
        </Border>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="0">

                <!-- Subcategory Sections -->
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding SubCategories}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:SubCategory">
                            <VerticalStackLayout>

                                <!-- Subcategory Title -->
                                <Border StrokeThickness="0"
                                        StrokeShape="RoundRectangle 5"
                                        Style="{x:StaticResource catTitleBorder}">
                                    <Label Text="{Binding Name}"
                                           Style="{x:StaticResource CatTitleText}"/>
                                </Border>

                                <!-- Products in Subcategory -->
                                <CollectionView ItemsSource="{Binding Products}"
                                                x:Name="ProductCollectionView"
                                                SelectionMode="Single"
                                                SelectionChangedCommand="{Binding Source={x:Reference CategoryPageRoot}, Path=BindingContext.GoToProductDetailCommand}"
                                                SelectionChangedCommandParameter="{Binding SelectedItem, Source={x:Reference ProductCollectionView}}"
                                                HeightRequest="180">
                                    <CollectionView.ItemsLayout>
                                        <LinearItemsLayout Orientation="Horizontal"/>
                                    </CollectionView.ItemsLayout>

                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:Product">
                                            <Border StrokeShape="RoundRectangle 5"
                                                    StrokeThickness="0.5"
                                                    Background="#fff"
                                                    WidthRequest="125"
                                                    HeightRequest="150"
                                                    Margin="5">
                                                <Grid RowDefinitions="*,auto">
                                                    <Image Source="{Binding ImageUrl}" Aspect="AspectFill"/>
                                                    <VerticalStackLayout Grid.Row="1" Padding="5">
                                                        <Label Text="{Binding Name}" FontAttributes="Bold" LineBreakMode="TailTruncation" MaxLines="1"/>
                                                        <HorizontalStackLayout>
                                                            <Label Text="{x:Static icons:Icons.locationIcon}" FontFamily="MaterialIcon" Margin="0,2,0,0"/>
                                                            <Label Text="{Binding ShopLocation}"
                                                                    FontFamily="Finlandica"/>
                                                        </HorizontalStackLayout>
                                                        <Label Text="{Binding FormattedPrice}" TextColor="{StaticResource Primary}" FontAttributes="Bold"/>
                                                    </VerticalStackLayout>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
