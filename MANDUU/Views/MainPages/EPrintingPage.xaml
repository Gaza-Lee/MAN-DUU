<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:icons="clr-namespace:MANDUU.Helpers"
             xmlns:models="clr-namespace:MANDUU.Models"
             xmlns:converters="clr-namespace:MANDUU.Converters"
             x:Name="EPrintingPageRoot"
             x:Class="MANDUU.Views.MainPages.EPrintingPage">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:ActiveStatusColorConvertor x:Key="ActiveStatusColorConvertor"/>
            <converters:StationSelectionToColorConverter x:Key="StationSelectionToColorConverter"/>
            <converters:StationSelectionToBackgroundConverter x:Key="StationSelectionToBackgroundConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Shell.TitleView>
        <Grid ColumnDefinitions="auto,* ,auto"
          Padding="0, 0, 5, 0"
          Margin="0"
          VerticalOptions="Center">
            
            <Label Grid.Column="0" 
               Text="{x:Static icons:Icons.profileIcon}"
               HorizontalOptions="Start"
               FontFamily="MaterialIcon"
               VerticalOptions="Center"
               FontSize="30">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding GoToProfileCommand}"/>
                </Label.GestureRecognizers>
            </Label>

            <Label Text="Electronic Printing"
                   Grid.Column="1"
                   Style="{StaticResource SubHeadline}"
                   HorizontalTextAlignment="Center"
                   VerticalOptions="Center"/>

            <Grid VerticalOptions="Center" HorizontalOptions="End" WidthRequest="40" HeightRequest="40"
                      Grid.Column="2">
                <!-- Cart Icon -->
                <Label Text="{x:Static icons:Icons.cartIcon}"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       FontFamily="MaterialIcon"
                       FontSize="30">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding GoToCartCommand}"/>
                    </Label.GestureRecognizers>
                </Label>

                <!-- Badge Dot - Positioned Top Right -->
                <Border BackgroundColor="Red"
                        HeightRequest="10"
                        WidthRequest="10"
                        StrokeThickness="0"
                        StrokeShape="RoundRectangle 5"
                        IsVisible="{Binding HasCartItems}"
                        HorizontalOptions="End"
                        VerticalOptions="Start"
                        Margin="0,0,2,2" />
            </Grid>
        </Grid>
    </Shell.TitleView>

    <Grid RowDefinitions="auto,*" RowSpacing="10">
        <VerticalStackLayout Grid.Row="0" Spacing="5">
            <Border HorizontalOptions="Center"
                VerticalOptions="Center"
                Background="{AppThemeBinding Dark={StaticResource Gray600}, Light={StaticResource Gray100}}"
                StrokeShape="RoundRectangle 5"
                StrokeThickness="0"
                Padding="10,5">
                <Border.Shadow>
                    <Shadow Offset="5,0"
                        Opacity="0.2"
                        Brush="{AppThemeBinding Dark={StaticResource Gray600}, Light={StaticResource White}}"/>
                </Border.Shadow>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding SelectDocumentCommand}"/>
                </Border.GestureRecognizers>
                <HorizontalStackLayout Spacing="5">
                    <Label Text="{x:Static icons:Icons.documentIcon}"
                           Style="{StaticResource MaterialIcon}"
                           FontSize="60"/>
                    <Border Background="{StaticResource Primary}"
                            VerticalOptions="Center"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 5"
                            Padding="10,5">
                        <HorizontalStackLayout >
                            <Label Text="{x:Static icons:Icons.UploadIcon}"
                                   Style="{StaticResource MaterialIcon}"
                                   FontSize="26"/>
                            <Label Text="Upload Document"
                                   x:Name="UploadLabel"
                                   VerticalTextAlignment="Center"
                                   Style="{StaticResource ButtonLabelText}"
                                   FontSize="20">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label"
                                                 Binding="{Binding IsDocumentSelected}"
                                                 Value="True">
                                        <Setter Property="IsVisible" Value="False"/>
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>

                            <Label x:Name="DocumentLabel"
                                   Text="{Binding SelectedDocument}"
                                   VerticalTextAlignment="Center"
                                   TextColor="#fff"
                                   FontSize="16"
                                   FontFamily="Finlandica"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="1"
                                   IsVisible="False">
                                <Label.Triggers>
                                    <!-- Show only when a document is selected -->
                                    <DataTrigger TargetType="Label"
                                     Binding="{Binding IsDocumentSelected}"
                                     Value="True">
                                        <Setter Property="IsVisible" Value="True"/>
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>
            </Border>
            <HorizontalStackLayout HorizontalOptions="Center" Spacing="5">
                <Label Text="{x:Static icons:Icons.infoIcon}"
                       Style="{StaticResource MaterialIcon}"
                       TextColor="Red"/>
                <Label Text="Select Printing station and upload document"
                       VerticalTextAlignment="Center"
                       TextColor="Red"/>
            </HorizontalStackLayout>
        </VerticalStackLayout>

        <Grid Grid.Row="1" Margin="10" RowSpacing="10" RowDefinitions="auto,auto,*">
            <Label Text="Available Printing Stations"
                   FontSize="Title"
                   HorizontalOptions="Center" Grid.Row="0"/>
            <Grid Margin="20,0" Grid.Row="1" ColumnDefinitions="*,*">
                <Border Stroke="Gray"
                        HorizontalOptions="Start"
                        StrokeShape="RoundRectangle 5" >
                    <SearchBar Text="{Binding SearchText}"/>
                </Border>
                <!-- Active Filter Toggle -->
                <HorizontalStackLayout Grid.Column="1" HorizontalOptions="End">
                    <CheckBox IsChecked="{Binding IsActive}"
                              VerticalOptions="Center"/>
                    <Label Text="Active Only"
                           VerticalOptions="Center"/>
                </HorizontalStackLayout>
            </Grid>

            <CollectionView ItemsSource="{Binding DisplayStations}" Grid.Row="2">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:PrintingStation">
                        <Border StrokeThickness="2"
                                StrokeShape="RoundRectangle 10"
                                Padding="10"
                                Margin="0,5">
                            <Border.Stroke>
                                <MultiBinding Converter="{StaticResource StationSelectionToColorConverter}">
                                    <Binding Path="Id"/>
                                    <Binding Path="BindingContext.SelectedStation.Id" Source="{x:Reference EPrintingPageRoot}"/>
                                </MultiBinding>
                            </Border.Stroke>
                            
                            <Border.Background>
                                <MultiBinding Converter="{StaticResource StationSelectionToBackgroundConverter}">
                                    <Binding Path="Id"/>
                                    <Binding Path="BindingContext.SelectedStation.Id" Source="{x:Reference EPrintingPageRoot}"/>
                                </MultiBinding>
                            </Border.Background>

                            <Grid ColumnSpacing="20" ColumnDefinitions="auto,*,auto">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding BindingContext.SelectStationCommand, Source={x:Reference EPrintingPageRoot}}"
                                        CommandParameter="{Binding .}"/>
                                </Grid.GestureRecognizers>

                                <Border StrokeThickness="0"
                                        StrokeShape="RoundRectangle 100"
                                        Background="{StaticResource Primary}"
                                        Padding="5"
                                        VerticalOptions="Center"
                                        HorizontalOptions="Start"
                                        Grid.Column="0">
                                    <Label Text="{x:Static icons:Icons.ePrintIcon}"
                                           Style="{StaticResource MaterialIcon}"
                                           FontSize="60"
                                           TextColor="#fff"/>
                                </Border>

                                <VerticalStackLayout Grid.Column="1" Spacing="5">
                                    <Label Text="{Binding Name}"
                                           Style="{StaticResource Title}"/>
                                    <Grid ColumnDefinitions="* ,*">
                                        <HorizontalStackLayout HorizontalOptions="Start" Grid.Column="0" Spacing="2">
                                            <Label Text="{x:Static icons:Icons.locationIcon}"
                                                  Style="{StaticResource MaterialIcon}"/>
                                            <Label Text="{Binding ShortLocation}"
                                                   TextColor="Gray"/>
                                        </HorizontalStackLayout>

                                        <Button Grid.Column="1" Style="{StaticResource CustomButton}"
                                                Text="Locate on map"
                                                FontSize="Small"
                                                Padding="5,2"
                                                HorizontalOptions="End"/>
                                    </Grid>
                                    <Label Text="{Binding PhoneNumber}"
                                           TextColor="{StaticResource Primary}"/>
                                </VerticalStackLayout>

                                <!--Active status-->
                                <Border StrokeShape="RoundRectangle 100"
                                        Background="{Binding Status, Converter={StaticResource ActiveStatusColorConvertor}}"
                                        HorizontalOptions="End"
                                        VerticalOptions="Center"
                                        StrokeThickness="0"
                                        WidthRequest="16"
                                        HeightRequest="16"
                                        Grid.Column="2"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </Grid>
</ContentPage>